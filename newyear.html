<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>8K Particle Magic - Music Edition</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Arial', sans-serif; }
        #video-preview { position: absolute; bottom: 20px; left: 20px; width: 160px; height: 120px; border: 2px solid #ff007f; border-radius: 10px; transform: scaleX(-1); background: #111; z-index: 50; }
        
        /* Tombol Start Imut di Kanan Bawah */
        .btn-cute-pink {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            padding: 15px 35px;
            background: linear-gradient(45deg, #ff7eb9, #ff007f);
            color: white;
            font-weight: bold;
            font-size: 18px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(255, 0, 127, 0.4);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: floating 3s ease-in-out infinite;
        }

        .btn-cute-pink:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 30px rgba(255, 0, 127, 0.6);
        }

        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>

    <button id="startBtn" class="btn-cute-pink">ðŸ’– MULAI REA MAGIC ðŸ’–</button>
    
    <audio id="bgMusic" loop>
        <source src="1226.MP3" type="audio/mpeg">
    </audio>

    <video id="webcam" style="display:none;" autoplay playsinline></video>
    <canvas id="video-preview"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';
        import { MeshSurfaceSampler } from 'three/addons/math/MeshSurfaceSampler.js';

        let scene, camera, renderer, mesh, stars;
        const count = 8000; 
        const dummy = new THREE.Object3D();
        const particles = [];
        let coordsLove = [], coordsNewYear = [], coordsHeart = [], coordsRea = [];

        // Inisialisasi Audio
        const music = document.getElementById('bgMusic');

        async function init3D() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.z = 80;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const mat = new THREE.MeshStandardMaterial({ 
                color: 0xff007f, 
                emissive: 0xff007f, 
                emissiveIntensity: 3 
            });
            mesh = new THREE.InstancedMesh(new THREE.SphereGeometry(0.25, 6, 6), mat, count);
            scene.add(mesh, new THREE.AmbientLight(0xffffff, 1));

            // Background Bintang
            const sGeo = new THREE.BufferGeometry();
            const sPos = [];
            for(let i=0; i<3000; i++) sPos.push((Math.random()-0.5)*1000, (Math.random()-0.5)*1000, (Math.random()-0.5)*500);
            sGeo.setAttribute('position', new THREE.Float32BufferAttribute(sPos, 3));
            stars = new THREE.Points(sGeo, new THREE.PointsMaterial({color: 0xffffff, size: 0.5}));
            scene.add(stars);

            // Heart Coords (Solid)
            for(let i=0; i<count; i++) {
                const t = Math.random() * Math.PI * 2;
                const r = Math.sqrt(Math.random()) * 2; 
                const x = r * (16 * Math.pow(Math.sin(t), 3));
                const y = r * (13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
                coordsHeart.push(new THREE.Vector3(x, y, (Math.random()-0.5)*5));
                particles.push({ pos: new THREE.Vector3(0,0,0), target: new THREE.Vector3(0,0,0) });
            }

            const loader = new FontLoader();
            loader.load('https://unpkg.com/three@0.160.0/examples/fonts/helvetiker_bold.typeface.json', (font) => {
                const createSolidCoords = (text, size) => {
                    const geo = new TextGeometry(text, { font: font, size: size, height: 2, curveSegments: 12 });
                    geo.center();
                    const textMesh = new THREE.Mesh(geo);
                    const sampler = new MeshSurfaceSampler(textMesh).build();
                    const res = [];
                    const tempV = new THREE.Vector3();
                    for(let i=0; i<count; i++) {
                        sampler.sample(tempV);
                        res.push(new THREE.Vector3(tempV.x, tempV.y, tempV.z));
                    }
                    return res;
                };

                coordsLove = createSolidCoords('I LOVE YOU', 8);
                coordsNewYear = createSolidCoords('HAPPY 2026', 7);
                coordsRea = createSolidCoords('REA', 15);
                animate();
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            stars.rotation.z += 0.0003;
            particles.forEach((p, i) => {
                p.pos.lerp(p.target, 0.12);
                dummy.position.copy(p.pos);
                dummy.updateMatrix();
                mesh.setMatrixAt(i, dummy.matrix);
            });
            mesh.instanceMatrix.needsUpdate = true;
            renderer.render(scene, camera);
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.75 });

        hands.onResults((results) => {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                const ox = (0.5 - lm[9].x) * 120;
                const oy = (0.5 - lm[9].y) * 80;

                // Logika Gestur
                const isThumbUp = lm[4].y < lm[3].y && lm[8].y > lm[6].y && lm[12].y > lm[10].y; 
                const isFist = lm[8].y > lm[6].y && lm[12].y > lm[10].y;
                const isTwoFingers = lm[8].y < lm[6].y && lm[12].y < lm[10].y && lm[16].y > lm[14].y;

                particles.forEach((p, i) => {
                    let target;
                    if (isThumbUp) target = coordsRea[i];
                    else if (isFist) target = coordsHeart[i];
                    else if (isTwoFingers) target = coordsNewYear[i];
                    else target = coordsLove[i];

                    if(target) p.target.set(ox + target.x, oy + target.y, target.z);
                });
            }
        });

        // Event Listener Tombol Baru
        document.getElementById('startBtn').addEventListener('click', () => {
            document.getElementById('startBtn').style.display = 'none';
            
            // Putar Musik
            music.play().catch(e => console.log("Musik gagal diputar:", e));

            init3D();
            const video = document.getElementById('webcam');
            new Camera(video, {
                onFrame: async () => {
                    await hands.send({image: video});
                    const ctx = document.getElementById('video-preview').getContext('2d');
                    ctx.save(); ctx.scale(-1, 1); ctx.translate(-160, 0);
                    ctx.drawImage(video, 0, 0, 160, 120);
                    ctx.restore();
                }
            }).start();
        });
    </script>
</body>
</html>